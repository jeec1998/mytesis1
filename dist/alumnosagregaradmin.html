<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrar Alumno</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: white;
            color: #333;
        }

        .volver-icono {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: #28a745;
            /* verde bonito */
            font-size: 25px;
            font-weight: bold;
            text-decoration: none;
            transition: color 0.3s, transform 0.2s;
        }

        .volver-icono:hover {
            color: #218838;
            transform: scale(1.05);
            /* Cambiado de 1.25 a 1.05 para un efecto m√°s sutil */
        }

        .volver-icono i {
            font-size: 30px;
        }

        nav {
            background-color: #07376C;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 24px;
        }

        nav .logo {
            color: white;
            font-size: 22px;
            font-weight: bold;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
        }

        main {
            padding: 30px;
            max-width: 100%;
            margin: auto;
            align-items: center;
        }

        #estiloCheckboxes {
            display: flex;
            flex-direction: column;
            gap: 12px;
            font-family: sans-serif;
            font-size: 16px;
            margin-left: 35%;
        }

        #estiloCheckboxes label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        #estiloCheckboxes input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        h2 {
            color: #07376c;
            margin-bottom: 20px;
        }

        #btnMostrarForm {
            background-color: #07376c;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
        }

        #btnMostrarForm:hover {
            background-color: #07376c;
        }

        form {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            max-width: 500px;
            margin: 0 auto 40px auto;
            display: none;
            flex-direction: column;
            gap: 15px;
        }

        form input,
        form select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        form button {
            padding: 10px 16px;
            background-color: #07376c;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        form button:hover {
            background-color: #07376c;
        }

        table {
            width: 100%;
            margin: 0 auto;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            table-layout: fixed;
        }

        th,
        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: center;
            word-wrap: break-word;
            /* Asegura que el texto largo no desborde */
        }

        th {
            background-color: #07376c;
            color: white;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        /* Ajustes de ancho para las nuevas columnas de la tabla */
        table th:nth-child(1),
        table td:nth-child(1) {
            width: 25%;
        }

        /* Nombre */
        table th:nth-child(2),
        table td:nth-child(2) {
            width: 18%;
        }

        /* Representante */
        table th:nth-child(3),
        table td:nth-child(3) {
            width: 18%;
        }

        /* Estilo */
        table th:nth-child(4),
        table td:nth-child(4) {
            width: 15%;
        }

        /* Curso y Paralelo */
        table th:nth-child(5),
        table td:nth-child(5) {
            width: 24%;
        }

        /* Acciones */


        .table-container {
            max-width: 100%;
        }

        #alertaContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .alerta {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #edf2f7;
            color: #333;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 12px;
            font-size: 15px;
            opacity: 1;
            transition: opacity 0.5s, transform 0.3s;
        }

        .alerta-success {
            background-color: #d4edda;
            color: #155724;
        }

        .alerta-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .alerta-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .alerta .icono {
            font-size: 20px;
        }

        @media (max-width: 768px) {

            form,
            .table-container {
                width: 100%;
            }

            #estiloCheckboxes {
                margin-left: 0;
                align-items: flex-start;
            }

            /* Ajustes de ancho para m√≥viles */
            table th:nth-child(1),
            table td:nth-child(1) {
                width: 30%;
            }

            table th:nth-child(2),
            table td:nth-child(2) {
                width: 20%;
            }

            table th:nth-child(3),
            table td:nth-child(3) {
                width: 18%;
            }

            table th:nth-child(4),
            table td:nth-child(4) {
                width: 15%;
            }

            table th:nth-child(5),
            table td:nth-child(5) {
                width: 17%;
            }
        }

        #confirmModal,
        #confirmcontraModal,
        #popupWhatsapp {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #confirmModal div,
        #confirmcontraModal div,
        #popupWhatsapp div {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #confirmModal button,
        #confirmcontraModal button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        #confirmBtn {
            background-color: #f44336;
            color: white;
        }

        #cancelBtn {
            background-color: #ccc;
            color: white;
            margin-left: 10px;
        }

        #confirmBtnReset {
            background-color: #07376c;
            color: white;
        }

        #cancelBtnReset {
            background-color: #ccc;
            color: white;
            margin-left: 10px;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination-controls button {
            background-color: #07376c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .pagination-controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .pagination-controls span {
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div id="alertaContainer"></div>

    <nav>
        <div class="logo">Panel</div>
        <ul>
            <li><a href="admin.html">Docentes</a></li>
            <li><a href="perfil.html">Perfil</a></li>
        </ul>
    </nav>
    <main>
        <a href="javascript:history.back()" class="volver-icono">
            <i class="fas fa-circle-arrow-left"></i>
        </a>
        <h2 id="tituloFormulario">Alumnos</h2>
        <button id="btnMostrarForm">‚ûï Agregar Alumno</button>

        <form id="alumnoForm">
            <input type="text" id="name" placeholder="Nombre completo" required />
            <input type="email" id="email" placeholder="Correo electr√≥nico" required />
            <input type="text" id="telefono" placeholder="Tel√©fono" required />
            <input type="text" id="telefonorepresentante" placeholder="Tel√©fono del representante" required />
            <div>
                <select id="selectCursoParalelo" required>
                    <option value="">Seleccione Curso y Paralelo</option>
                    <option value="8A">Octavo EGB - A</option>
                    <option value="8B">Octavo EGB - B</option>
                    <option value="8C">Octavo EGB - C</option>
                    <option value="8D">Octavo EGB - D</option>
                    <option value="8E">Octavo EGB - E</option>
                    <option value="8F">Octavo EGB - F</option>
                    <option value="8G">Octavo EGB - G</option>
                    <option value="8H">Octavo EGB - H</option>
                    <option value="8I">Octavo EGB - I</option>

                    <option value="9A">Noveno EGB - A</option>
                    <option value="9B">Noveno EGB - B</option>
                    <option value="9C">Noveno EGB - C</option>
                    <option value="9D">Noveno EGB - D</option>
                    <option value="9E">Noveno EGB - E</option>
                    <option value="9F">Noveno EGB - F</option>
                    <option value="9G">Noveno EGB - G</option>
                    <option value="9H">Noveno EGB - H</option>
                    <option value="9I">Noveno EGB - I</option>

                    <option value="10A">D√©cimo EGB - A</option>
                    <option value="10B">D√©cimo EGB - B</option>
                    <option value="10C">D√©cimo EGB - C</option>
                    <option value="10D">D√©cimo EGB - D</option>
                    <option value="10E">D√©cimo EGB - E</option>
                    <option value="10F">D√©cimo EGB - F</option>
                    <option value="10G">D√©cimo EGB - G</option>
                    <option value="10H">D√©cimo EGB - H</option>
                    <option value="10I">D√©cimo EGB - I</option>

                    <option value="1A">Primero BGU - A</option>
                    <option value="1B">Primero BGU - B</option>
                    <option value="1C">Primero BGU - C</option>
                    <option value="1D">Primero BGU - D</option>
                    <option value="1E">Primero BGU - E</option>
                    <option value="1F">Primero BGU - F</option>
                    <option value="1G">Primero BGU - G</option>
                    <option value="1H">Primero BGU - H</option>
                    <option value="1I">Primero BGU - I</option>

                    <option value="2A">Segundo BGU - A</option>
                    <option value="2B">Segundo BGU - B</option>
                    <option value="2C">Segundo BGU - C</option>
                    <option value="2D">Segundo BGU - D</option>
                    <option value="2E">Segundo BGU - E</option>
                    <option value="2F">Segundo BGU - F</option>
                    <option value="2G">Segundo BGU - G</option>
                    <option value="2H">Segundo BGU - H</option>
                    <option value="2I">Segundo BGU - I</option>

                    <option value="3A">Tercero BGU - A</option>
                    <option value="3B">Tercero BGU - B</option>
                    <option value="3C">Tercero BGU - C</option>
                    <option value="3D">Tercero BGU - D</option>
                    <option value="3E">Tercero BGU - E</option>
                    <option value="3F">Tercero BGU - F</option>
                    <option value="3G">Tercero BGU - G</option>
                    <option value="3H">Tercero BGU - H</option>
                    <option value="3I">Tercero BGU - I</option>
                </select>
            </div>
            <label for="estiloLabel" style="margin-bottom:8px; font-weight:bold;">Se√±ale el estilo de aprendizaje del
                alumno:</label>
            <div id="estiloCheckboxes">
                <label><input type="checkbox" name="estilo" value="activo" /> Activo</label>
                <label><input type="checkbox" name="estilo" value="reflexivo" /> Reflexivo</label>
                <label><input type="checkbox" name="estilo" value="te√≥rico" /> Te√≥rico</label>
                <label><input type="checkbox" name="estilo" value="pragm√°tico" /> Pragm√°tico</label>
            </div>
            <label for="estiloLabel" style="margin-bottom:8px; font-weight:bold;">Por favor, indique si el alumno
                presenta Necesidades Educativas Especiales (NEE):</label>
            <div id="estiloCheckboxes">
                <label><input type="checkbox" value="NEE" id="checkboxNEE"> NEE</label>
            </div>
            <input type="hidden" id="createbysubject" />
            <div class="form-buttons">
                <button type="submit" id="submitBtn">Registrar Alumno</button>
                <button type="button" id="cancelarBtn" style="background-color:gray;">Cancelar</button>
            </div>
        </form>
        <div class="cards-container" id="materiasContainer"></div>
        <div id="confirmModal">
            <div>
                <h3>¬øEst√°s seguro de eliminar este alumno?</h3>
                <div>
                    <button id="confirmBtn">Eliminar</button>
                    <button id="cancelBtn">Cancelar</button>
                </div>
            </div>
        </div>
        <input type="text" id="buscadorAlumno" placeholder="Buscar alumno por nombre..."
            style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ccc; border-radius:6px;" />

        <div style="margin-bottom: 20px; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto;">
            <select id="filtroCursoParalelo"
                style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc;">
                <option value="">Todos los Cursos y Paralelos</option>
                <option value="8A">Octavo EGB - A</option>
                <option value="8B">Octavo EGB - B</option>
                <option value="8C">Octavo EGB - C</option>
                <option value="8D">Octavo EGB - D</option>
                <option value="8E">Octavo EGB - E</option>
                <option value="8F">Octavo EGB - F</option>
                <option value="8G">Octavo EGB - G</option>
                <option value="8H">Octavo EGB - H</option>
                <option value="8I">Octavo EGB - I</option>

                <option value="9A">Noveno EGB - A</option>
                <option value="9B">Noveno EGB - B</option>
                <option value="9C">Noveno EGB - C</option>
                <option value="9D">Noveno EGB - D</option>
                <option value="9E">Noveno EGB - E</option>
                <option value="9F">Noveno EGB - F</option>
                <option value="9G">Noveno EGB - G</option>
                <option value="9H">Noveno EGB - H</option>
                <option value="9I">Noveno EGB - I</option>

                <option value="10A">D√©cimo EGB - A</option>
                <option value="10B">D√©cimo EGB - B</option>
                <option value="10C">D√©cimo EGB - C</option>
                <option value="10D">D√©cimo EGB - D</option>
                <option value="10E">D√©cimo EGB - E</option>
                <option value="10F">D√©cimo EGB - F</option>
                <option value="10G">D√©cimo EGB - G</option>
                <option value="10H">D√©cimo EGB - H</option>
                <option value="10I">D√©cimo EGB - I</option>

                <option value="1A">Primero BGU - A</option>
                <option value="1B">Primero BGU - B</option>
                <option value="1C">Primero BGU - C</option>
                <option value="1D">Primero BGU - D</option>
                <option value="1E">Primero BGU - E</option>
                <option value="1F">Primero BGU - F</option>
                <option value="1G">Primero BGU - G</option>
                <option value="1H">Primero BGU - H</option>
                <option value="1I">Primero BGU - I</option>

                <option value="2A">Segundo BGU - A</option>
                <option value="2B">Segundo BGU - B</option>
                <option value="2C">Segundo BGU - C</option>
                <option value="2D">Segundo BGU - D</option>
                <option value="2E">Segundo BGU - E</option>
                <option value="2F">Segundo BGU - F</option>
                <option value="2G">Segundo BGU - G</option>
                <option value="2H">Segundo BGU - H</option>
                <option value="2I">Segundo BGU - I</option>

                <option value="3A">Tercero BGU - A</option>
                <option value="3B">Tercero BGU - B</option>
                <option value="3C">Tercero BGU - C</option>
                <option value="3D">Tercero BGU - D</option>
                <option value="3E">Tercero BGU - E</option>
                <option value="3F">Tercero BGU - F</option>
                <option value="3G">Tercero BGU - G</option>
                <option value="3H">Tercero BGU - H</option>
                <option value="3I">Tercero BGU - I</option>
            </select>
        </div>

        <div class="table-container">
            <h2>Alumnos Registrados</h2>
            <table id="tablaAlumnos">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Representante</th>
                        <th>Estilo</th>
                        <th>Curso y Paralelo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="confirmcontraModal">
            <div>
                <h3>¬øEst√°s seguro de restablecer la contrase√±a?</h3>
                <br />
                <div>
                    <button id="confirmBtnReset">Restablecer</button>
                    <button id="cancelBtnReset">Cancelar</button>
                </div>
            </div>
        </div>
        <div class="pagination-controls">
            <button id="prevPage" disabled>‚ùÆ Anterior</button>
            <span id="pageInfo">P√°gina 1 de 1</span>
            <button id="nextPage">Siguiente ‚ùØ</button>
        </div>
    </main>

    <script src="https://unpkg.com/imask"></script>
    <script>
        const API = 'https://mentoria-api-cyffg2cdemdyfdbt.eastus2-01.azurewebsites.net/users';
        const form = document.getElementById('alumnoForm');
        const submitBtn = document.getElementById('submitBtn');
        const cancelarBtn = document.getElementById('cancelarBtn');
        const tablaAlumnosBody = document.querySelector('#tablaAlumnos tbody');
        const tituloFormulario = document.getElementById('tituloFormulario');
        const btnMostrarForm = document.getElementById('btnMostrarForm');
        let editandoAlumnoId = null;
        const alumnosPerPage = 10;
        let currentPage = 1;
        let alumnosCargados = []; // Almacena todos los alumnos para la b√∫squeda y filtro
        let filteredAlumnos = []; // Alumnos despu√©s de aplicar b√∫squeda y filtro de curso

        const selectCursoParalelo = document.getElementById('selectCursoParalelo');
        const filtroCursoParalelo = document.getElementById('filtroCursoParalelo'); // Nuevo elemento de filtro

        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInfoSpan = document.getElementById('pageInfo');
        const buscadorAlumno = document.getElementById('buscadorAlumno');

        let telefonoMaskInstance;
        let telefonoRepresentanteMaskInstance;

        function mostrarAlerta(mensaje, tipo = 'success') {
            const alertaContainer = document.getElementById('alertaContainer');
            const alerta = document.createElement('div');
            alerta.className = `alerta alerta-${tipo}`;
            const icon = document.createElement('span');
            icon.className = 'icono';
            if (tipo === 'success') icon.textContent = '‚úÖ';
            else if (tipo === 'error') icon.textContent = '‚ùå';
            else if (tipo === 'warning') icon.textContent = '‚ö†Ô∏è';
            else icon.textContent = '‚ÑπÔ∏è';
            const texto = document.createElement('span');
            texto.textContent = mensaje;
            alerta.appendChild(icon);
            alerta.appendChild(texto);
            alertaContainer.appendChild(alerta);
            setTimeout(() => {
                alerta.style.opacity = '0';
                setTimeout(() => alerta.remove(), 500);
            }, 4000);
        }

        const checkboxNEE = document.getElementById('checkboxNEE');
        checkboxNEE.checked = false;

        const params = new URLSearchParams(window.location.search);
        const docenteId = params.get('docenteId');
        const nombreDocente = params.get('nombre');
        const volverBtn = document.querySelector('nav ul li a');

        if (volverBtn) {
            if (docenteId && nombreDocente) {
                volverBtn.href = `materias-docentes.html?docenteId=${docenteId}&nombre=${encodeURIComponent(nombreDocente)}`;
            } else {
                volverBtn.href = 'admin.html';
            }
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('accessToken');
            return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
        }

        btnMostrarForm.onclick = () => {
            form.style.display = 'flex';
            btnMostrarForm.style.display = 'none';
            cancelarBtn.style.display = 'inline-block';
            tituloFormulario.textContent = 'Registrar Alumno';
            submitBtn.textContent = 'Registrar Alumno';
            resetFormularioInputs();
        };

        cancelarBtn.addEventListener('click', resetFormulario);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const estilosSeleccionados = Array.from(document.querySelectorAll('input[name="estilo"]:checked')).map(cb => cb.value);
            const telefono = document.getElementById('telefono').value;
            const telefonorepresentante = document.getElementById('telefonorepresentante').value;
            const cursoParalelo = selectCursoParalelo.value;

            const regexTelefono = /^\+5939\d{8}$/;

            if (!regexTelefono.test(telefono) || !regexTelefono.test(telefonorepresentante)) {
                mostrarAlerta('Los n√∫meros de tel√©fono deben comenzar con +5939 y tener 12 d√≠gitos en total (ej: +593912345678). Por favor, verifica.', 'error');
                return;
            }
            if (!cursoParalelo) {
                mostrarAlerta('Por favor, selecciona un Curso y Paralelo.', 'error');
                return;
            }

            const alumno = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                telefono: telefono,
                telefonorepresentante: telefonorepresentante,
                curso: cursoParalelo,
                estilo: estilosSeleccionados,
                var: checkboxNEE.checked,
                role: 'alumno'
            };

            try {
                const url = editandoAlumnoId ? `${API}/${editandoAlumnoId}` : API;
                const method = editandoAlumnoId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(alumno)
                });

                if (res.ok) {
                    mostrarAlerta(editandoAlumnoId ? 'Alumno actualizado correctamente ‚úÖ' : 'Alumno registrado exitosamente ‚úÖ');
                    resetFormulario();
                    cargarAlumnos();
                    const createdAlumno = await res.json();
                    if (createdAlumno.link) {
                        mostrarPopupWhatsapp(createdAlumno.link);
                    }
                } else {
                    const error = await res.json();
                    mostrarAlerta(error.message || 'Error en operaci√≥n', 'error');
                }
            } catch (error) {
                console.error(error);
                mostrarAlerta('Error de conexi√≥n', 'error');
            }
        });

        async function restablecerContrasena(id) {
            const confirmModal1 = document.getElementById('confirmcontraModal');
            const confirmBtnReset = document.getElementById('confirmBtnReset');
            const cancelBtnReset = document.getElementById('cancelBtnReset');

            confirmModal1.style.display = 'flex';

            confirmBtnReset.onclick = async () => {
                try {
                    const res = await fetch(`${API}/${id}/reset-password`, {
                        method: 'PUT',
                        headers: getAuthHeaders()
                    });

                    if (res.ok) {
                        const data = await res.json();
                        if (data.link) {
                            mostrarPopupWhatsapp(data.link);
                        } else {
                            mostrarAlerta('Contrase√±a restablecida correctamente ‚úÖ');
                        }
                    } else {
                        const error = await res.json();
                        mostrarAlerta(error.message || 'Error al restablecer contrase√±a', 'error');
                    }
                } catch (error) {
                    console.error('Error al restablecer contrase√±a:', error);
                    mostrarAlerta('Error de conexi√≥n', 'error');
                } finally {
                    confirmModal1.style.display = 'none';
                }
            };

            cancelBtnReset.onclick = () => {
                confirmModal1.style.display = 'none';
            };
        }

        function generateWhatsappLink(telefono, nombreUsuario, password) {
            const mensaje = `Hola, mi nombre de usuario es: ${nombreUsuario} y mi nueva contrase√±a es: ${password}`;
            return `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
        }

        function mostrarPopupWhatsapp(link) {
            const popup = document.getElementById('popupWhatsapp');
            const popupBtn = document.getElementById('popupWhatsappBtn');
            if (popup && popupBtn) {
                popupBtn.href = link;
                popup.style.display = 'flex';
                popupBtn.onclick = () => {
                    popup.style.display = 'none';
                    return true;
                };
            } else {
                console.error("Elementos del popup de WhatsApp (popupWhatsapp o popupWhatsappBtn) no encontrados!");
                window.open(link, '_blank');
            }
        }

        function resetFormularioInputs() {
            document.getElementById('name').value = '';
            document.getElementById('email').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('telefonorepresentante').value = '';
            selectCursoParalelo.value = '';
            document.querySelectorAll('input[name="estilo"]').forEach(cb => cb.checked = false);
            checkboxNEE.checked = false;
            editandoAlumnoId = null;
        }

        function resetFormulario() {
            form.reset();
            resetFormularioInputs();
            form.style.display = 'none';
            btnMostrarForm.style.display = 'inline-block';
            tituloFormulario.textContent = 'Alumnos';
            submitBtn.textContent = 'Registrar Alumno';
        }

        async function cargarAlumnos() {
            try {
                const res = await fetch(`${API}/alumnos`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                const alumnos = await res.json();
                alumnosCargados = alumnos;
                aplicarFiltrosYRenderizar();
            } catch (error) {
                console.error('Error al cargar alumnos:', error);
                mostrarAlerta('Error al cargar alumnos', 'error');
            }
        }

        function aplicarFiltrosYRenderizar() {
            let alumnosFiltradosPorCurso = [];
            const filtroCursoValor = filtroCursoParalelo.value;

            if (filtroCursoValor === '') {
                alumnosFiltradosPorCurso = [...alumnosCargados];
            } else {
                alumnosFiltradosPorCurso = alumnosCargados.filter(alumno => alumno.curso === filtroCursoValor);
            }

            const terminoBusqueda = buscadorAlumno.value.toLowerCase();
            filteredAlumnos = alumnosFiltradosPorCurso.filter(a => a.name.toLowerCase().includes(terminoBusqueda));

            currentPage = 1;
            renderTablaAlumnos();
        }


        function renderTablaAlumnos() {
            tablaAlumnosBody.innerHTML = '';

            if (filteredAlumnos.length === 0) {
                tablaAlumnosBody.innerHTML = '<tr><td colspan="5">No hay alumnos registrados que coincidan con la b√∫squeda o el filtro.</td></tr>';
                pageInfoSpan.textContent = `P√°gina 0 de 0`;
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
                return;
            }

            const totalPages = Math.ceil(filteredAlumnos.length / alumnosPerPage);

            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * alumnosPerPage;
            const endIndex = startIndex + alumnosPerPage;
            const alumnosToDisplay = filteredAlumnos.slice(startIndex, endIndex);

            alumnosToDisplay.forEach(alumno => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${alumno.name ? alumno.name.toUpperCase() : '-'}</td>
                <td>${alumno.telefonorepresentante || '-'}</td>
                <td>${Array.isArray(alumno.estilo) ? alumno.estilo.join(', ') : alumno.estilo || '-'}</td>
                <td>${alumno.curso || '-'}</td>
                <td>
                    <button onclick="editarAlumno('${alumno._id}')" style="background-color:#07376c; color:white; border:none; padding:6px 12px; border-radius:6px; margin-right:6px;">‚úèÔ∏è Editar</button>
                    <button onclick="eliminarAlumno('${alumno._id}')" style="background-color:#E94E77; color:white; border:none; padding:6px 12px; border-radius:6px; margin-right:6px;">üóëÔ∏è Eliminar</button>
                    <button onclick="restablecerContrasena('${alumno._id}')" style="background-color:#F4A261; color:white; border:none; padding:6px 12px; border-radius:6px;">üîë Restablecer Contrase√±a</button>
                </td>
            `;
                tablaAlumnosBody.appendChild(row);
            });

            pageInfoSpan.textContent = `P√°gina ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTablaAlumnos();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredAlumnos.length / alumnosPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTablaAlumnos();
            }
        });

        buscadorAlumno.addEventListener('input', () => {
            buscadorAlumno.value = buscadorAlumno.value.toUpperCase();
            aplicarFiltrosYRenderizar();
        });

        filtroCursoParalelo.addEventListener('change', () => {
            aplicarFiltrosYRenderizar();
        });


        async function editarAlumno(id) {
            try {
                const res = await fetch(`${API}/${id}`, { method: 'GET', headers: getAuthHeaders() });
                if (res.ok) {
                    const alumno = await res.json();
                    document.getElementById('name').value = alumno.name;
                    document.getElementById('email').value = alumno.email;
                    document.getElementById('telefono').value = alumno.telefono || '';
                    document.getElementById('telefonorepresentante').value = alumno.telefonorepresentante || '';

                    selectCursoParalelo.value = alumno.curso || '';

                    const checkboxes = document.querySelectorAll('input[name="estilo"]');
                    checkboxes.forEach(cb => cb.checked = Array.isArray(alumno.estilo) && alumno.estilo.includes(cb.value));
                    checkboxNEE.checked = alumno.var || false;

                    editandoAlumnoId = alumno._id;
                    submitBtn.textContent = 'Actualizar Alumno';
                    form.style.display = 'flex';
                    cancelarBtn.style.display = 'inline-block';
                    btnMostrarForm.style.display = 'none';
                    tituloFormulario.textContent = 'Editar Alumno';
                } else {
                    mostrarAlerta('Error al cargar datos del alumno para editar', 'error');
                }
            } catch (error) {
                console.error('Error al cargar alumno:', error);
                mostrarAlerta('Error de conexi√≥n al cargar datos', 'error');
            }
        }

        async function eliminarAlumno(id) {
            const confirmModal = document.getElementById('confirmModal');
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            confirmModal.style.display = 'flex';

            confirmBtn.onclick = async () => {
                try {
                    const res = await fetch(`${API}/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });

                    if (res.ok) {
                        mostrarAlerta('Alumno eliminado correctamente ‚úÖ');
                        cargarAlumnos();
                    } else {
                        const error = await res.json();
                        mostrarAlerta(error.message || 'Error al eliminar alumno', 'error');
                    }
                    confirmModal.style.display = 'none';
                } catch (err) {
                    console.error('Error al eliminar el alumno', err);
                    mostrarAlerta('Error en la conexi√≥n o al realizar la acci√≥n', 'error');
                    confirmModal.style.display = 'none';
                }
            };

            cancelBtn.onclick = () => {
                confirmModal.style.display = 'none';
            };
        }

        document.addEventListener('DOMContentLoaded', function () {
            const elementoTelefono = document.getElementById('telefono');
            const elementoTelefonoRepresentante = document.getElementById('telefonorepresentante');

            const opcionesMascara = {
                mask: '+{593}000000000',
                lazy: false
            };

            telefonoMaskInstance = IMask(elementoTelefono, opcionesMascara);
            telefonoRepresentanteMaskInstance = IMask(elementoTelefonoRepresentante, opcionesMascara);

            cargarAlumnos();
        });
    </script>

    <div id="popupWhatsapp">
        <div>
            <h3 style="margin-bottom:20px; color:#333;">Contrase√±a Generada</h3>
            <p style="margin-bottom:25px; color:#555;">Se gener√≥ un enlace para enviar la contrase√±a al alumno por
                WhatsApp.
                Debes hacer clic en el bot√≥n para continuar.</p>
            <a id="popupWhatsappBtn" href="#" target="_blank"
                style="background-color:#25D366; color:white; padding:12px 20px; border-radius:6px; text-decoration:none; font-weight:bold;">Ir
                al WhatsApp üöÄ</a>
        </div>
    </div>

</body>

</html>