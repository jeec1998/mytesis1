<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Docentes</title>
  <style>
    /* Aseguramos que html y body ocupen toda la pantalla */
    html,
    body {
      height: 10%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: white;
      color: #333;
      display: flex;
      flex-direction: column;
    }

    nav {
      background-color: #07376C;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1px 24px;
    }

    nav .logo {
      color: white;
      font-size: 22px;
      font-weight: bold;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 18px;
    }

    main {
      padding: 30px;
      max-width: 100%;
      margin: auto;
      align-items: center;
    }

    h2 {
      color: #07376c;
      margin-bottom: 20px;
    }

    #btnMostrarForm {
      background-color: #07376c;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin: auto auto 0 auto;
      display: block;
      align-items: center;
    }

    #btnMostrarForm:hover {
      background-color: #07376c;
    }

    form {
      width: 50%;
      background: white;
      padding: 45px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: none; /* Formulario oculto inicialmente */
      flex-direction: column;
      gap: 12px;
      align-items: center;
      margin: 0 auto;
    }

    form input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    form button {
      background-color: #07376c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 15px;
    }

    form button:hover {
      background-color: #07376c;
    }

    .botones-form {
      display: flex;
      gap: 10px;
    }

    #buscadorDocente {
      padding: 10px;
      margin-bottom: 20px;
      width: 80%;
      border: 1px solid #ccc;
      border-radius: 6px;
      align-items: center;
    }

    #docentesContainer {
      width: 90%;
      margin: 0 auto;
    }

    .buscarContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      align-content: center;
      margin-top: 20px;
    }

    table {
      width: 100%;
      margin: 0 auto;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
      table-layout: fixed;
      align-items: center;
      /* Hace que las celdas de la tabla tengan un ancho fijo */
    }

    th {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      word-wrap: break-word;
      /* Asegura que el texto largo se rompa en líneas */
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      word-wrap: break-word;
      /* Asegura que el texto largo se rompa en líneas */
    }

    th:nth-child(1),
    td:nth-child(1) {
      width: 250px;
    }

    th:nth-child(2),
    td:nth-child(2) {
      width: 250px;
    }

    td:nth-child(3) {
      align-items: right;
      text-align: right;
    }

    th {
      background-color: #07376c;
      color: white;
    }

    tr:hover {
      background-color: #f1f1f1;
      text-align: center;
    }

    button.action {
      padding: 8px 12px;
      background-color: #07376c;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 6px;
      font-size: 14px;
    }

    button.action:hover {
      background-color: #07376c;
    }

    /* Alerta flotante */
    #alertaContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    /* Media Queries para hacerlo responsive */
    @media (max-width: 1200px) {
      form {
        width: 60%;
      }

      #docentesContainer {
        width: 90%;
      }
    }

    @media (max-width: 768px) {
      form {
        width: 90%;
        /* El formulario ocupará más espacio */
      }

      #docentesContainer {
        width: 100%;
        /* Asegura que la tabla ocupe el 100% */
      }

      table {
        width: 100%;
        overflow-x: auto;
        /* Habilita el desplazamiento horizontal si es necesario */
        display: block;
        /* Hace que la tabla se pueda desplazar */
      }

      nav ul {
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }

      nav .logo {
        font-size: 18px;
      }

      button.action {
        width: 100%;
        /* Los botones ocuparán todo el ancho disponible */
        margin-top: 5px;
      }

      #buscadorDocente {
        width: 100%;
        /* El campo de búsqueda ocupa todo el ancho disponible */
      }

      .botones-form {
        flex-direction: column;
        /* Los botones se apilan verticalmente */
      }

      button.action,
      #btnMostrarForm {
        font-size: 14px;
        padding: 8px 10px;
      }

      #alertaContainer {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 9999;
      }

      th,
      td {
        padding: 10px 8px;
      }

      th:nth-child(1),
      td:nth-child(1) {
        width: auto;
      }
    }

    @media (max-width: 510px) {

      /* Ajustar el tamaño de la tabla */
      table {
        width: 100%;
        font-size: 12px;
        /* Reducir el tamaño de la fuente en la tabla */
        overflow-x: auto;
        /* Habilita desplazamiento horizontal si es necesario */
        display: block;
        /* Hacer que la tabla sea desplazable */
        margin: 0 auto;
      }

      /* Ajustar el tamaño de los botones de la tabla */
      button.action,
      #btnMostrarForm {
        width: 100%;
        /* Los botones ocuparán todo el ancho disponible */
        padding: 6px 10px;
        /* Reducir el tamaño del padding */
        font-size: 12px;
        /* Reducir el tamaño de la fuente */
        margin-top: 5px;
      }

      /* Ajustar el tamaño de la letra de la tabla */
      th,
      td {
        padding: 8px 12px;
        /* Reducir el padding de las celdas */
        font-size: 12px;
        /* Reducir el tamaño de la fuente */
      }

      /* Ajustar el tamaño del formulario */
      form {
        width: 90%;
        /* Ajusta el formulario para pantallas pequeñas */
      }

      /* Ajustar el tamaño del buscador */
      #buscadorDocente {
        width: 100%;
        /* El campo de búsqueda ocupa todo el ancho disponible */
        font-size: 12px;
        /* Reducir el tamaño de la fuente */
      }

      /* Ajuste de los enlaces en el menú de navegación */
      nav ul li a {
        font-size: 12px;
        /* Reducir el tamaño de la fuente de los enlaces */
      }

      /* Ajuste de la letra del logo */
      nav .logo {
        font-size: 16px;
        /* Reducir el tamaño del logo */
      }

      /* Asegurarse de que las celdas se ajusten al tamaño de la pantalla */
      th:nth-child(1),
      td:nth-child(1) {
        width: auto;
        /* Ajuste automático de la columna */
      }

      /* Eliminar el margen de los elementos flotantes */
      #alertaContainer {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 9999;
      }

      /* Ajuste general del diseño */
      nav ul {
        flex-direction: column;
        /* Los enlaces de la navegación se apilan */
        gap: 5px;
        align-items: center;
      }
    }
 #confirmDocenteModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#confirmDocenteModal div {
  background-color: white;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#confirmDocenteModal button {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

#confirmDocenteBtn {
  background-color: #f44336;
  color: white;
}

#cancelDocenteBtn {
  background-color: #ccc;
  color: white;
  margin-left: 10px;
}


  </style>
</head>

<body>

  <div id="alertaContainer"></div>

  <nav>
    <div class="logo">Panel</div>
    <ul>
      <li><a href="alumnosagregaradmin.html">Alumnos</a></li>
      <li><a href="perfil.html">Perfil</a></li>
    </ul>
  </nav>

  <main>
   <h2 id="tituloForm">Docentes</h2>
    <button id="btnMostrarForm">➕ Agregar Docente</button>
     <form id="formDocente" style="display: none;">
      <input type="text" id="nombreDocente" placeholder="Nombre completo" required>
      <input type="email" id="emailDocente" placeholder="Correo electrónico" required>
      <input type="text" id="telefonoDocente" placeholder="+593 968144760" required />
      <div class="botones-form">
        <button type="submit" id="btnGuardar">Guardar Docente</button>
        <button type="button" id="cancelarBtn" style="background-color: gray; display: none;">Cancelar</button>
      </div>
    </form>
    <div class="buscarContainer">
      <input type="text" id="buscadorDocente" placeholder="Buscar docente por nombre...">
    </div>
    <div id="docentesContainer"></div>
<!-- Modal de Confirmación para eliminar docente -->
<div id="confirmDocenteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;">
  <div style="background-color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
    <h3>¿Estás seguro de eliminar este docente?</h3>
    <div>
      <button id="confirmDocenteBtn" style="background-color: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">Eliminar</button>
      <button id="cancelDocenteBtn" style="background-color: #ccc; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancelar</button>
    </div>
  </div>
</div>

   
  </main>

  <script src="https://unpkg.com/imask"></script>
  <script>
    const API_USERS = 'http://localhost:3000/users';
    let todosLosDocentes = [];
    let editandoId = null;  // Este id servirá para verificar si estamos editando o creando un docente

    const cancelarBtn = document.getElementById('cancelarBtn');
    const btnMostrarForm = document.getElementById('btnMostrarForm');
    const form = document.getElementById('formDocente');
    const btnGuardar = document.getElementById('btnGuardar');

    // Mostrar alerta
    function mostrarAlerta(mensaje, tipo = 'success') {
      const alertaContainer = document.getElementById('alertaContainer');
      const alerta = document.createElement('div');
      alerta.textContent = mensaje;
      alerta.style.backgroundColor = tipo === 'success' ? '#4CAF50' : '#f44336';
      alerta.style.color = 'white';
      alerta.style.padding = '12px 20px';
      alerta.style.marginBottom = '10px';
      alerta.style.borderRadius = '8px';
      alerta.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
      alerta.style.fontSize = '16px';
      alerta.style.minWidth = '250px';
      alerta.style.textAlign = 'center';
      alerta.style.opacity = '0';
      alerta.style.transition = 'opacity 0.5s';

      alertaContainer.appendChild(alerta);

      setTimeout(() => {
        alerta.style.opacity = '1';
        setTimeout(() => {
          alerta.style.opacity = '0';
          setTimeout(() => alerta.remove(), 500);
        }, 3000);
      }, 100);
    }

    // Get Authorization Headers
    function getAuthHeaders() {
      const token = localStorage.getItem('accessToken');
      return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    }

    // Fetch docentes
    async function fetchDocentes() {
      const res = await fetch(API_USERS, { method: 'GET', headers: getAuthHeaders() });
      const data = await res.json();
      todosLosDocentes = data.filter(user => user.role === 'docente');
      renderTablaDocentes(todosLosDocentes);
    }

    // Render tabla de docentes
    function renderTablaDocentes(docentes) {
      const container = document.getElementById('docentesContainer');
      if (!docentes.length) {
        container.innerHTML = '<p>No hay docentes registrados.</p>';
        return;
      }
      let html = '<table><thead><tr><th>Nombre</th><th>Correo</th><th>Acciones</th></tr></thead><tbody>';
      docentes.forEach(doc => {
        html += `<tr>
      <td>${doc.name}</td>
      <td>${doc.email}</td>
      <td>
        <button class="action" onclick="verMateriasDocente('${doc._id}', '${doc.name}')">📘 Ver Materias</button>
        <button class="action" onclick="editarDocente('${doc._id}')">✏️ Editar</button>
        <button class="action" onclick="eliminarDocente('${doc._id}')">🗑️ Eliminar</button>
        <button onclick="restablecerContrasenaDocente('${doc._id}')" class="action" style="background-color:#F4A261; color:white; border:none; padding:6px 12px; border-radius:6px;">🔑 Restablecer Contraseña</button>
      </td>
    </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Ver materias de docente
    function verMateriasDocente(id, nombre) {
      window.location.href = `materias-docentes.html?docenteId=${id}&nombre=${encodeURIComponent(nombre)}`;
    }

    // Eliminar docente
  async function eliminarDocente(id) {
  // Mostrar el modal
  const confirmModal = document.getElementById('confirmDocenteModal');
  const confirmBtn = document.getElementById('confirmDocenteBtn');
  const cancelBtn = document.getElementById('cancelDocenteBtn');

  confirmModal.style.display = 'flex';  // Mostrar el modal

  // Confirmar la eliminación cuando el usuario hace clic en el botón de eliminar
  confirmBtn.onclick = async () => {
    const res = await fetch(`${API_USERS}/${id}`, { method: 'DELETE', headers: getAuthHeaders() });

    if (res.ok) {
      mostrarAlerta('Docente eliminado correctamente ✅');
      fetchDocentes();
    } else {
      mostrarAlerta('Error al eliminar docente ❌', 'error');
    }

    // Cerrar el modal después de realizar la acción
    confirmModal.style.display = 'none';
  };

  // Cancelar la eliminación cuando el usuario hace clic en el botón de cancelar
  cancelBtn.onclick = () => {
    confirmModal.style.display = 'none';  // Cerrar el modal
  };
}

    // Editar docente
    async function editarDocente(id) {
      const res = await fetch(`${API_USERS}/${id}`, { method: 'GET', headers: getAuthHeaders() });
      if (res.ok) {
        const docente = await res.json();
        // Rellenar el formulario con los datos del docente
        document.getElementById('nombreDocente').value = docente.name;
        document.getElementById('emailDocente').value = docente.email;
        document.getElementById('telefonoDocente').value = docente.telefono;

        // Mostrar el formulario y cambiar el botón
        form.style.display = 'flex';
        btnMostrarForm.style.display = 'none';
        cancelarBtn.style.display = 'inline-block';
         btnMostrarForm.style.margin = '20px auto 0 auto'; 

        // Cambiar el texto del botón
        btnGuardar.textContent = 'Actualizar Docente';
        editandoId = docente._id;  // Guardar el ID del docente que estamos editando
      }
    }


    // Mostrar formulario
    btnMostrarForm.onclick = () => {
      form.style.display = 'flex';
      btnMostrarForm.style.display = 'none';
      cancelarBtn.style.display = 'inline-block';
    };

    // Cancelar formulario
    cancelarBtn.addEventListener('click', () => {
      form.style.display = 'none';
      btnMostrarForm.style.display = 'block';
      cancelarBtn.style.display = 'none';
      editandoId = null;
      btnMostrarForm.style.margin = '20px auto 0 auto';
    });

    // Guardar o actualizar docente
    form.onsubmit = async (e) => {
      e.preventDefault();
      const telefono = document.getElementById('telefonoDocente').value;

      // Verifica si el número de teléfono cumple con el formato
      const regexTelefono = /^\+5939\d{8}$/; // Debe ser +593 seguido de un 9 y 8 dígitos
      if (!regexTelefono.test(telefono)) {
        mostrarAlerta('El número de teléfono no es válido. Debe comenzar con +593  seguido de 9 dígitos.', 'error');
        return;
      }

      const nuevoDocente = {
        name: document.getElementById('nombreDocente').value,
        email: document.getElementById('emailDocente').value,
        telefono: document.getElementById('telefonoDocente').value,
        role: 'docente'
      };

      const url = editandoId ? `${API_USERS}/${editandoId}` : API_USERS;
      const method = editandoId ? 'PUT' : 'POST';
      const res = await fetch(url, { method, headers: getAuthHeaders(), body: JSON.stringify(nuevoDocente) });

      if (res.ok) {
        const createdDocente = await res.json();  // Aquí obtenemos la respuesta del servidor
        mostrarAlerta(editandoId ? 'Docente actualizado correctamente ✅' : 'Docente registrado exitosamente ✅');
        form.reset();
        form.style.display = 'none';
        btnMostrarForm.style.display = 'inline-block';
         editandoId = null;  // Reseteamos el ID de edición
         btnGuardar.textContent = 'Guardar Docente';  // Reseteamos el texto del botón
        cancelarBtn.style.display = 'none';
         btnMostrarForm.style.margin = '20px auto 0 auto'; 
        fetchDocentes();

        // Verificamos si la respuesta contiene un enlace para WhatsApp
        if (createdDocente.link) {
          mostrarPopupWhatsapp(createdDocente.link);  // Si hay un enlace, mostramos el popup
        } else {
          /* mostrarAlerta('Usuario creado sin teléfono o enlace de WhatsApp', 'warning'); */
        }

      } else {
        const error = await res.json();
        mostrarAlerta(error.message || 'Error en operación', 'error');
      }
    };

    // Buscar docente
    document.getElementById('buscadorDocente').addEventListener('input', function () {
      const termino = this.value.toLowerCase();
      const filtrados = todosLosDocentes.filter(docente => docente.name.toLowerCase().includes(termino));
      renderTablaDocentes(filtrados);
    });

    async function restablecerContrasenaDocente(id) {
      if (!confirm("¿Seguro que deseas restablecer la contraseña? Se generará una nueva automáticamente.")) return;

      try {
        const res = await fetch(`${API_USERS}/${id}/reset-password`, {
          method: 'PUT',
          headers: getAuthHeaders()
        });

        if (res.ok) {
          const data = await res.json();
          if (data.link) {
            mostrarPopupWhatsapp(data.link);
          } else {
            mostrarAlerta('Contraseña restablecida correctamente ✅');
          }
        } else {
          const error = await res.json();
          mostrarAlerta(error.message || 'Error al restablecer contraseña', 'error');
        }
      } catch (error) {
        console.error('Error al restablecer contraseña:', error);
        mostrarAlerta('Error de conexión', 'error');
      }
    }

    function generateWhatsappLink(telefono, nombreUsuario, password) {
      const mensaje = `Hola, mi nombre de usuario es: ${nombreUsuario} y mi nueva contraseña es: ${password}`;
      return `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
    }

    function mostrarPopupWhatsapp(link) {
      const popup = document.getElementById('popupWhatsapp');
      const popupBtn = document.getElementById('popupWhatsappBtn');
      popupBtn.href = link;
      popup.style.display = 'flex';  // Muestra el popup

      popupBtn.onclick = () => {
        popup.style.display = 'none';  // Oculta el popup al hacer clic en el enlace
        return true;  // Permite que el enlace abra en una nueva pestaña
      };
    }

    // Aplicando máscara de entrada
      document.addEventListener('DOMContentLoaded', function () {

            // 3. Seleccionar el elemento
            const elementoTelefono = document.getElementById('telefonoDocente');

            // 4. Definir las opciones de la máscara de forma muy intuitiva
            const opcionesMascara = {
                mask: '+{593}900000000', // El '0' es un comodín para un dígito
                lazy: false // La máscara se muestra desde el inicio
            };
            
            // 5. Aplicar la máscara
            const mascara = IMask(elementoTelefono, opcionesMascara);

            // --- Cómo validar usando IMask.js ---
            function validarTelefono() {
                // El método 'isComplete' te dice si todos los caracteres fueron ingresados
                if (mascara.masked.isComplete) {
                    // El valor sin máscara se obtiene con 'unmaskedValue'
                    console.log('Número completo y válido:', mascara.value);
                    console.log('Valor sin máscara:', mascara.unmaskedValue);
                    // Aquí iría tu lógica si el teléfono es válido
                } else {
                    console.log('Número incompleto.');
                     // Aquí muestras tu alerta de error
                }
            }
             // Puedes llamar a la función validarTelefono() cuando envíes el formulario
        });

    fetchDocentes();
  </script>

  <div id="popupWhatsapp"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10000;">
    <div
      style="background:white; padding:30px; border-radius:12px; max-width:400px; text-align:center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin-bottom:20px; color:#333;">Contraseña Generada</h3>
      <p style="margin-bottom:25px; color:#555;">Se generó un enlace para enviar la contraseña al docente por WhatsApp.
        Debes hacer clic en el botón para continuar.</p>
      <a id="popupWhatsappBtn" href="#" target="_blank"
        style="background-color:#25D366; color:white; padding:12px 20px; border-radius:6px; text-decoration:none; font-weight:bold;">Ir
        al WhatsApp 🚀</a>
    </div>
  </div>

</body>
</html>
