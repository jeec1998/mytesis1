<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Docentes</title>
  <style>/* Aseguramos que html y body ocupen toda la pantalla */
html, body {
  height: 10%;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #f4f9ff;
  color: #333;
  display: flex;
  flex-direction: column;
}

nav {
  background-color: #4A90E2;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 24px;
}

nav .logo {
  color: white;
  font-size: 22px;
  font-weight: bold;
}

nav ul {
  list-style: none;
  display: flex;
  gap: 20px;
}

nav ul li a {
  color: white;
  text-decoration: none;
  font-size: 16px;
}

nav ul li a:hover {
  background-color: #357ABD;
  border-radius: 5px;
  padding: 6px 10px;
}

main {
  padding: 30px;
  max-width: 100%;
  margin: auto;
}

h2 {
  color: #4A90E2;
  margin-bottom: 20px;
}

#btnMostrarForm {
  background-color: #4A90E2;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  margin-bottom: 20px;
}

#btnMostrarForm:hover {
  background-color: #357ABD;
}

form {
  width: 50%;
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
  display: none;
  flex-direction: column;
  gap: 12px;
}

form input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

form button {
  background-color: #4A90E2;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px 16px;
  font-size: 14px;
  cursor: pointer;
}

form button:hover {
  background-color: #357ABD;
}

.botones-form {
  display: flex;
  gap: 10px;
}

#buscadorDocente {
  padding: 10px;
  margin-bottom: 20px;
  width: 100%;
  border: 1px solid #ccc;
  border-radius: 6px;
}

#docentesContainer {
  width: 80%;
  margin: 0 auto;
}

table {
  width: 100%;
  margin: 0 auto;
  border-collapse: collapse;
  background-color: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  overflow: hidden;
  table-layout: fixed; /* Hace que las celdas de la tabla tengan un ancho fijo */
}

th, td {
  padding: 12px 16px;
  border-bottom: 1px solid #ddd;
  text-align: center;
  word-wrap: break-word; /* Asegura que el texto largo se rompa en l√≠neas */
}

th:nth-child(1), td:nth-child(1) {
  width: 200px;
}

th {
  background-color: #4A90E2;
  color: white;
}

tr:hover {
  background-color: #f1f1f1;
}

button.action {
  padding: 8px 12px;
  background-color: #4A90E2;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-right: 6px;
  font-size: 14px;
}

button.action:hover {
  background-color: #357ABD;
}

/* Alerta flotante */
#alertaContainer {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}

/* Media Queries para hacerlo responsive */
@media (max-width: 1200px) {
  form {
    width: 60%;
  }

  #docentesContainer {
    width: 90%;
  }
}

@media (max-width: 768px) {
  form {
    width: 90%; /* El formulario ocupar√° m√°s espacio */
  }

  #docentesContainer {
    width: 100%; /* Asegura que la tabla ocupe el 100% */
  }

  table {
    width: 100%;
    overflow-x: auto; /* Habilita el desplazamiento horizontal si es necesario */
    display: block; /* Hace que la tabla se pueda desplazar */
  }

  nav ul {
    flex-direction: column;
    gap: 10px;
    align-items: center;
  }

  nav .logo {
    font-size: 18px;
  }

  button.action {
    width: 100%; /* Los botones ocupar√°n todo el ancho disponible */
    margin-top: 5px;
  }

  #buscadorDocente {
    width: 100%; /* El campo de b√∫squeda ocupa todo el ancho disponible */
  }

  .botones-form {
    flex-direction: column; /* Los botones se apilan verticalmente */
  }

  button.action, #btnMostrarForm {
    font-size: 14px;
    padding: 8px 10px;
  }

  #alertaContainer {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 9999;
  }

  th, td {
    padding: 10px 8px;
  }

  th:nth-child(1), td:nth-child(1) {
    width: auto;
  }
}


@media (max-width: 510px) {
  /* Ajustar el tama√±o de la tabla */
  table {
    width: 100%;
    font-size: 12px; /* Reducir el tama√±o de la fuente en la tabla */
    overflow-x: auto; /* Habilita desplazamiento horizontal si es necesario */
    display: block; /* Hacer que la tabla sea desplazable */
    margin: 0 auto;
  }

  /* Ajustar el tama√±o de los botones de la tabla */
  button.action, #btnMostrarForm {
    width: 100%; /* Los botones ocupar√°n todo el ancho disponible */
    padding: 6px 10px; /* Reducir el tama√±o del padding */
    font-size: 12px; /* Reducir el tama√±o de la fuente */
    margin-top: 5px;
  }

  /* Ajustar el tama√±o de la letra de la tabla */
  th, td {
    padding: 8px 12px; /* Reducir el padding de las celdas */
    font-size: 12px; /* Reducir el tama√±o de la fuente */
  }

  /* Ajustar el tama√±o del formulario */
  form {
    width: 90%; /* Ajusta el formulario para pantallas peque√±as */
  }

  /* Ajustar el tama√±o del buscador */
  #buscadorDocente {
    width: 100%; /* El campo de b√∫squeda ocupa todo el ancho disponible */
    font-size: 12px; /* Reducir el tama√±o de la fuente */
  }

  /* Ajuste de los enlaces en el men√∫ de navegaci√≥n */
  nav ul li a {
    font-size: 12px; /* Reducir el tama√±o de la fuente de los enlaces */
  }

  /* Ajuste de la letra del logo */
  nav .logo {
    font-size: 16px; /* Reducir el tama√±o del logo */
  }

  /* Asegurarse de que las celdas se ajusten al tama√±o de la pantalla */
  th:nth-child(1), td:nth-child(1) {
    width: auto; /* Ajuste autom√°tico de la columna */
  }

  /* Eliminar el margen de los elementos flotantes */
  #alertaContainer {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 9999;
  }

  /* Ajuste general del dise√±o */
  nav ul {
    flex-direction: column; /* Los enlaces de la navegaci√≥n se apilan */
    gap: 5px;
    align-items: center;
  }
}

</style>
</head>

<body>

  <div id="alertaContainer"></div> 

  <nav>
    <div class="logo">Panel</div>
    <ul>
      <li><a href="perfil.html">Perfil</a></li>
    </ul>
  </nav>

  <main>
    <h2 id="tituloForm">Docentes</h2>
    <button id="btnMostrarForm">‚ûï Agregar Docente</button>

    <form id="formDocente">
      <input type="text" id="nombreDocente" placeholder="Nombre completo" required>
      <input type="email" id="emailDocente" placeholder="Correo electr√≥nico" required>
    <input type="text" id="telefonoDocente" placeholder="+593 968144760" required/>
      <div class="botones-form">
        <button type="submit" id="btnGuardar">Guardar Docente</button>
        <button type="button" id="btnCancelar" style="background-color: gray; display: none;">Cancelar</button>
      </div>
    </form>

    <input type="text" id="buscadorDocente" placeholder="Buscar docente por nombre...">
    <div id="docentesContainer"></div>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.6/inputmask.min.js"></script>
  <script>
    const API_USERS = 'http://localhost:3000/users';
    let todosLosDocentes = [];
    let editandoId = null;

    function mostrarAlerta(mensaje, tipo = 'success') {
  const alertaContainer = document.getElementById('alertaContainer');
  const alerta = document.createElement('div');
  alerta.textContent = mensaje;
  alerta.style.backgroundColor = tipo === 'success' ? '#4CAF50' : '#f44336';
  alerta.style.color = 'white';
  alerta.style.padding = '12px 20px';
  alerta.style.marginBottom = '10px';
  alerta.style.borderRadius = '8px';
  alerta.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
  alerta.style.fontSize = '16px';
  alerta.style.minWidth = '250px';
  alerta.style.textAlign = 'center';
  alerta.style.opacity = '0';
  alerta.style.transition = 'opacity 0.5s';

  alertaContainer.appendChild(alerta);

  setTimeout(() => {
    alerta.style.opacity = '1';
    setTimeout(() => {
      alerta.style.opacity = '0';
      setTimeout(() => alerta.remove(), 500);
    }, 3000);
  }, 100);
}

    function getAuthHeaders() {
      const token = localStorage.getItem('accessToken');
      return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    }

    async function fetchDocentes() {
      const res = await fetch(API_USERS, { method: 'GET', headers: getAuthHeaders() });
      const data = await res.json();
      todosLosDocentes = data.filter(user => user.role === 'docente');
      renderTablaDocentes(todosLosDocentes);
    }

    function renderTablaDocentes(docentes) {
      const container = document.getElementById('docentesContainer');
      if (!docentes.length) {
        container.innerHTML = '<p>No hay docentes registrados.</p>';
        return;
      }
      let html = '<table><thead><tr><th>Nombre</th><th>Correo</th><th>Acciones</th></tr></thead><tbody>';
      docentes.forEach(doc => {
        html += `<tr>
      <td>${doc.name}</td>
      <td>${doc.email}</td>
      <td>
        <button class="action" onclick="verMateriasDocente('${doc._id}', '${doc.name}')">üìò Ver Materias</button>
        <button class="action" onclick="editarDocente('${doc._id}')">‚úèÔ∏è Editar</button>
        <button class="action" onclick="eliminarDocente('${doc._id}')">üóëÔ∏è Eliminar</button>
        <button onclick="restablecerContrasenaDocente('${doc._id}')" classs= "action"style="background-color:#F4A261; color:white; border:none; padding:6px 12px; border-radius:6px;">üîë Restablecer Contrase√±a</button>
      </td>
    </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function verMateriasDocente(id, nombre) {
      window.location.href = `materias-docentes.html?docenteId=${id}&nombre=${encodeURIComponent(nombre)}`;
    }

    async function eliminarDocente(id) {
      if (!confirm('¬øSeguro que quieres eliminar este docente?')) return;
      const res = await fetch(`${API_USERS}/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
      if (res.ok) {
        mostrarAlerta('Docente eliminado correctamente ‚úÖ');
        fetchDocentes();
      } else {
        mostrarAlerta('Error al eliminar docente ‚ùå', 'error');
      }
    }

    async function editarDocente(id) {
      const res = await fetch(`${API_USERS}/${id}`, { method: 'GET', headers: getAuthHeaders() });
      if (res.ok) {
        const docente = await res.json();
        document.getElementById('nombreDocente').value = docente.name;
        document.getElementById('emailDocente').value = docente.email;
        document.getElementById('telefonoDocente').value = docente.telefono;
        editandoId = docente._id;
        mostrarFormulario(true);
      }
    }

    function mostrarFormulario(editando = false) {
      document.getElementById('formDocente').style.display = 'flex';
      document.getElementById('btnMostrarForm').style.display = 'none';
      document.getElementById('btnCancelar').style.display = 'inline-block';
      document.getElementById('btnGuardar').textContent = editando ? 'Actualizar Docente' : 'Guardar Docente';
    }

    function ocultarFormulario() {
      document.getElementById('formDocente').reset();
      document.getElementById('formDocente').style.display = 'none';
      document.getElementById('btnMostrarForm').style.display = 'inline-block';
      document.getElementById('btnCancelar').style.display = 'none';
      editandoId = null;
    }

    document.getElementById('btnMostrarForm').onclick = () => mostrarFormulario(false);
    document.getElementById('btnCancelar').onclick = () => ocultarFormulario();

    document.getElementById('formDocente').onsubmit = async (e) => {
  e.preventDefault();
  const telefono = document.getElementById('telefonoDocente').value;

// Verifica si el n√∫mero de tel√©fono cumple con el formato
const regexTelefono = /^\+5939\d{8}$/; // Debe ser +593 seguido de un 9 y 8 d√≠gitos
if (!regexTelefono.test(telefono)) {
  mostrarAlerta('El n√∫mero de tel√©fono no es v√°lido. Debe comenzar con +593  seguido de 9 d√≠gitos.', 'error');
  return;
}
  const nuevoDocente = {
    name: document.getElementById('nombreDocente').value,
    email: document.getElementById('emailDocente').value,
    telefono: document.getElementById('telefonoDocente').value,
    role: 'docente'
  };

  const url = editandoId ? `${API_USERS}/${editandoId}` : API_USERS;
  const method = editandoId ? 'PUT' : 'POST';
  const res = await fetch(url, { method, headers: getAuthHeaders(), body: JSON.stringify(nuevoDocente) });

  if (res.ok) {
    const createdDocente = await res.json();  // Aqu√≠ obtenemos la respuesta del servidor

    mostrarAlerta(editandoId ? 'Docente actualizado correctamente ‚úÖ' : 'Docente registrado exitosamente ‚úÖ');
    ocultarFormulario();
    fetchDocentes();

    // Verificamos si la respuesta contiene un enlace para WhatsApp
    if (createdDocente.link) {
      mostrarPopupWhatsapp(createdDocente.link);  // Si hay un enlace, mostramos el popup
    } else {
      mostrarAlerta('Usuario creado sin tel√©fono o enlace de WhatsApp', 'warning');
    }

  } else {
    const error = await res.json();
    mostrarAlerta(error.message || 'Error en operaci√≥n', 'error');
  }
};


    document.getElementById('buscadorDocente').addEventListener('input', function () {
      const termino = this.value.toLowerCase();
      const filtrados = todosLosDocentes.filter(docente => docente.name.toLowerCase().includes(termino));
      renderTablaDocentes(filtrados);
    });
    async function restablecerContrasenaDocente(id) {
  if (!confirm("¬øSeguro que deseas restablecer la contrase√±a? Se generar√° una nueva autom√°ticamente.")) return;

  try {
    const res = await fetch(`${API_USERS}/${id}/reset-password`, {
      method: 'PUT',
      headers: getAuthHeaders()
    });

    if (res.ok) {
      const data = await res.json();

      if (data.link) {
     
        mostrarPopupWhatsapp(data.link);
      } else {
        mostrarAlerta('Contrase√±a restablecida correctamente ‚úÖ');
      }
    } else {
      const error = await res.json();
      mostrarAlerta(error.message || 'Error al restablecer contrase√±a', 'error');
    }
  } catch (error) {
    console.error('Error al restablecer contrase√±a:', error);
    mostrarAlerta('Error de conexi√≥n', 'error');
  }
}

    function generateWhatsappLink(telefono, nombreUsuario, password) {
      const mensaje = `Hola, mi nombre de usuario es: ${nombreUsuario} y mi nueva contrase√±a es: ${password}`;
      return `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
    }
function mostrarPopupWhatsapp(link) {
  const popup = document.getElementById('popupWhatsapp');
  const popupBtn = document.getElementById('popupWhatsappBtn');
  popupBtn.href = link; // Asigna el enlace al bot√≥n del popup
  popup.style.display = 'flex'; // Muestra el popup

  popupBtn.onclick = () => {
    popup.style.display = 'none'; // Oculta el popup al hacer clic en el enlace
    return true; // Permite que el enlace abra en una nueva pesta√±a
  };
}
   // Aplicando m√°scara de entrada
   window.onload = function() {
      const input = document.getElementById('telefonoDocente');
      const im = new Inputmask({
        "mask": "+593 9{8}",
        "numericInput": true
      });
      im.mask(input);
    };
    fetchDocentes();
  </script>
<div id="popupWhatsapp" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10000;">
  <div style="background:white; padding:30px; border-radius:12px; max-width:400px; text-align:center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
    <h3 style="margin-bottom:20px; color:#333;">Contrase√±a Generada</h3>
    <p style="margin-bottom:25px; color:#555;">Se gener√≥ un enlace para enviar la contrase√±a al docente por WhatsApp. Debes hacer clic en el bot√≥n para continuar.</p>
    <a id="popupWhatsappBtn" href="#" target="_blank" style="background-color:#25D366; color:white; padding:12px 20px; border-radius:6px; text-decoration:none; font-weight:bold;">Ir al WhatsApp üöÄ</a>
  </div>
</div>

</body>

</html>