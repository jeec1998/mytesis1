<!DOCTYPE html> 
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Refuerzos Acad√©micos</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #D6E6F2;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: #2F80ED;
      color: white;
      padding: 12px 20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .left-section {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .menu-icon {
      font-size: 26px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background-color 0.2s;
    }

    .menu-icon:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .header-title {
      font-weight: bold;
      font-size: 20px;
      letter-spacing: 0.5px;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
    }

    main {
      flex: 1;
      padding: 30px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      overflow-y: auto;
    }

    .card {
      width: 200px;
      height: 280px;
      border-radius: 14px;
      background: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.2s;
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      color: white;
    }

    /* Colores para los headers seg√∫n materia */
    .header-rojo {
      background: linear-gradient(135deg, #f44336, #e53935);
    }

    .header-amarillo {
      background: linear-gradient(135deg, #ffeb3b, #fbc02d);
      color: #333;
    }

    .header-verde {
      background: linear-gradient(135deg, #4caf50, #43a047);
    }

    .header-azul {
      background: linear-gradient(135deg, #4A90E2, #357ABD);
      color: white;
    }

    .header-naranja {
      background: linear-gradient(135deg, #ff9800, #f57c00);
    }

    .header-morado {
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
    }

    .header-cian {
      background: linear-gradient(135deg, #00bcd4, #0097a7);
    }

.card-content {
  flex: 1;
  padding: 12px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center;
  font-size: 13px;
  color: #444;
}

.card-content p {
  margin: 6px 0;
}

.card-buttons {
  display: flex;
  gap: 6px;
  justify-content: center;
  padding: 8px;
  background-color: #f0f4ff;
  border-top: 1px solid #e0e0e0;
}

.card-buttons button {
  flex: 1 1 80px;
  background-color: #4A90E2;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px;
  font-size: 13px;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.2s;
}

.card-buttons button:hover {
  background-color: #357ABD;
}

/* Drawer y Modal */
#drawer {
  position: fixed;
  top: 0;
  left: -260px;
  width: 260px;
  height: 100%;
  background-color: #D6E6F2;
  padding: 50px 20px 30px;
  box-shadow: 4px 0 6px rgba(0, 0, 0, 0.1);
  transition: left 0.3s ease;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.drawer-item {
  font-size: 18px;
  padding: 15px 0;
  border-bottom: 1px solid #A7C7E7;
  color: #2F4F6E;
  cursor: pointer;
  font-weight: 500;
}

.logout {
  color: #C62828;
  border-bottom-color: #C62828;
}

#drawer-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.3);
  display: none;
  z-index: 1000;
}

#drawer-overlay.show {
  display: block;
}

#drawer.show {
  left: 0;
}

#modal-confirm {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

#modal-confirm-content {
  background: white;
  padding: 30px;
  border-radius: 10px;
  text-align: center;
  font-size: 18px;
  color: #333;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  max-width: 300px;
}

#modal-confirm-content button {
  margin-top: 15px;
  margin-right: 10px;
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
}

#confirm-yes {
  background-color: #4CAF50;
  color: white;
}

#confirm-no {
  background-color: #F44336;
  color: white;
}

  </style>
</head>

<body>
  <header>
    <div class="left-section">
      <button id="menu-btn" class="menu-icon">‚ò∞</button>
      <span class="header-title">Materias</span>
    </div>
    <div class="user-section" id="user-section">
      <span>üë§</span> <span id="nombre-usuario"></span>
    </div>
  </header>

  <main id="refuerzos-container"></main>

  <div id="drawer-overlay"></div>
  <div id="drawer">
    <div>
      <div class="drawer-item" onclick="navigateTo('perfil.html')">üë§ Perfil</div>
      <div class="drawer-item" onclick="navigateTo('home-alumno.html')">üè† Materias</div>
    </div>
    <div class="drawer-item logout" onclick="logout()">üì§ Cerrar sesi√≥n</div>
  </div>

  <div id="modal-confirm">
    <div id="modal-confirm-content">
      ¬øDeseas cerrar sesi√≥n?<br>
      <button id="confirm-yes">S√≠</button>
      <button id="confirm-no">No</button>
    </div>
  </div>

  <script>
    function obtenerClaseColor(materia) {
      materia = materia.toLowerCase();
      if (materia.includes('lengua')) return 'header-naranja';
      if (materia.includes('sociales')) return 'header-morado';
      if (materia.includes('matem√°ticas')) return 'header-verde';
      if (materia.includes('naturales')) return 'header-rojo';
      if (materia.includes('ingl√©s')) return 'header-amarillo';
      return 'header-azul';
    }

    function getUserIdFromToken(token) {
      if (!token) return null;
      try {
        const payload = token.split('.')[1];
        const decoded = atob(payload);
        const obj = JSON.parse(decoded);
        return obj._id || obj.id || null;
      } catch {
        return null;
      }
    }

    async function cargarMateriasPorUsuario(userId) {
      const token = localStorage.getItem('accessToken');
      if (!token || !userId) {
        window.location.href = 'index.html';
        return;
      }

      try {
        const res = await fetch(`https://mentoria-api-cyffg2cdemdyfdbt.eastus2-01.azurewebsites.net/users/${userId}/materia`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!res.ok) throw new Error('Error al obtener materias');

        const materias = await res.json();

        const container = document.getElementById('refuerzos-container');
        container.innerHTML = '';

        if (!Array.isArray(materias) || materias.length === 0) {
          container.innerHTML = '<p>No se encontraron materias para este usuario.</p>';
          return;
        }

        materias.forEach(materiaData => {
          const nombreMateria = materiaData.name || materiaData.materia || 'Materia sin nombre';

          const card = document.createElement('div');
          card.className = 'card';
          card.onclick = () => abrirActividades(nombreMateria);

          const header = document.createElement('div');
          header.className = 'card-header ' + obtenerClaseColor(nombreMateria);
          header.textContent = nombreMateria;

          card.appendChild(header);
          container.appendChild(card);
        });
      } catch (error) {
        console.error(error);
        alert('Error cargando materias.');
      }
    }

    function abrirActividades(materia) {
      window.location.href = `actividades.html?materia=${encodeURIComponent(materia)}`;
    }

    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawer-overlay');
    const menuBtn = document.getElementById('menu-btn');
    menuBtn.onclick = () => {
      drawer.classList.add('show');
      overlay.classList.add('show');
    };
    overlay.onclick = () => {
      drawer.classList.remove('show');
      overlay.classList.remove('show');
    };

    function navigateTo(path) {
      drawer.classList.remove('show');
      overlay.classList.remove('show');
      setTimeout(() => {
        window.location.href = path;
      }, 300);
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    document.getElementById('user-section').onclick = () => {
      window.location.href = 'perfil.html';
    };

    const modalConfirm = document.getElementById('modal-confirm');
    const confirmYes = document.getElementById('confirm-yes');
    const confirmNo = document.getElementById('confirm-no');

    window.addEventListener('popstate', () => {
      modalConfirm.style.display = 'flex';
    });

    confirmYes.onclick = () => {
      localStorage.clear();
      window.location.href = 'index.html';
    };

    confirmNo.onclick = () => {
      modalConfirm.style.display = 'none';
      history.pushState(null, '', location.href);
    };

    history.pushState(null, '', location.href);

    async function cargarPerfil() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        window.location.href = 'index.html';
        return;
      }
      try {
        const res = await fetch('https://mentoria-api-cyffg2cdemdyfdbt.eastus2-01.azurewebsites.net/users/perfil', {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const { usuario } = await res.json();
        document.getElementById('nombre-usuario').textContent = usuario.nombreUsuario || 'Usuario';
      } catch (error) {
        console.error(error);
        window.location.href = 'index.html';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await cargarPerfil();

      const token = localStorage.getItem('accessToken');
      const userId = getUserIdFromToken(token);

      if (!userId) {
        alert('Usuario no autenticado');
        window.location.href = 'index.html';
        return;
      }

      cargarMateriasPorUsuario(userId);
    });
  </script>
</body>

</html>
