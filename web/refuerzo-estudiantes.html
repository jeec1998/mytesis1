<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Refuerzo</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: white;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 10vh;
      flex-direction: column;
    }

    nav {
      background-color: #07376c;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 10;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    nav .logo {
      color: white;
      font-size: 22px;
      font-weight: bold;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-size: 16px;
      padding: 6px 10px;
      transition: background 0.3s;
    }

    nav ul li a:hover {
      background-color: #07376c;
      border-radius: 5px;
    }

    main {
      padding: 30px;
      width: 100%;
      margin-top: 80px;
    }

    h2 {
      color: #07376c;
      text-align: center;
      margin-bottom: 10px;
    }

    .selector-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    select,
    button {
      padding: 10px 26px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      outline: none;
      cursor: pointer;
      width: 400px;
    }

    select:focus,
    button:focus {
      box-shadow: 0 0 8px rgba(66, 133, 244, 0.8);
    }

    button {
      background-color: #07376c;
      color: white;
      font-weight: bold;
      border: none;
      transition: background 0.3s;
      width: 200px;
    }
    #topicSelect {
      max-width: 300px;
    }

    /* Estilo para la tabla */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 40px;
    }

    table th,
    table td {
      padding: 12px;
      text-align: left;
      border: 1px solid #ddd;
    }

    table th:nth-child(1),
    table td:nth-child(1) {
      width: 20%;
    }

    table th:nth-child(2),
    table td:nth-child(2) {
      width: 40%;
    }

    table th:nth-child(3),
    table td:nth-child(3) {
      width: 20%;
    }

    table th:nth-child(4),
    table td:nth-child(4) {
      width: 20%;
    }

    table th {
      background-color: #07376c;
      color: white;
    }

    table tbody tr:nth-child(even) {
      background-color: #f4f9ff;
    }

    table tbody tr:hover {
      background-color: #e2e6f1;
    }

    #alertaContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    /* Responsive: Ajustar los selectores en pantallas pequeñas */
    @media screen and (max-width: 768px) {
      .selector-container {
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }

      select,
      button {
        width: 90%;
      }
    }
  </style>
</head>

<body>

  <div id="alertaContainer"></div>

  <nav>
    <div class="logo">Calificaciones</div>
    <ul>
      <li><a href="javascript:history.back()">Volver</a></li>
       <li><a href="perfil.html">Perfil</a></li>
    </ul>
  </nav>

  <main>
    <h2>Seleccione una Materia y un Tema</h2>
    <div class="selector-container">
      <div>
        <label for="materiasContainer">Materia:</label>
        <select id="materiasContainer">
          <option value="">Seleccione una materia</option>
        </select>
      </div>

      <div>
        <label for="topicSelect">Tema:</label>
        <select id="topicSelect">
          <option value="">Seleccione un tema</option>
        </select>
      </div>
    </div>

    <!-- Tabla de alumnos -->
    <h2>Alumnos Registrados</h2>
    <table id="tablaAlumnos">
      <thead>
        <tr>
          <th>Alumno</th>
          <th>Subtemas</th>
          <th>Calificación máxima</th>
          <th>Calificación Obtenida</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="text-align: center; margin-top: 20px;">
      <button id="enviarBtn">Enviar Calificaciones</button>
       <button id="refuerzoBtn">Generar Refuerzo</button>
      
    </div>
  </main>

  <script>
    // ... tu script sin cambios hasta la función sendGrades ...
    const API = 'https://mentoria-api-cyffg2cdemdyfdbt.eastus2-01.azurewebsites.net/Subjects';
    const API_TOPICS = 'https://mentoria-api-cyffg2cdemdyfdbt.eastus2-01.azurewebsites.net/topics';
    const API_ALUMNOS = 'https://mentoria-api-cyffg2cdemdyfdbt.eastus2-01.azurewebsites.net/users';
    const API_GRADES = 'https://mentoria-api-cyffg2cdemdyfdbt.eastus2-01.azurewebsites.net/grades';
    const tablaAlumnosBody = document.querySelector('#tablaAlumnos tbody');
    let materiaId;
    let temas = [];

    function getAuthHeaders() {
      const token = localStorage.getItem('accessToken');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    // ... todas tus otras funciones (cargarMaterias, cargarAlumnos, etc.) sin cambios ...
    
    // Función para cargar las materias del docente
    async function cargarMaterias() {
      const docenteId = localStorage.getItem('userId');
      try {
        const res = await fetch(`https://mentoria-api-cyffg2cdemdyfdbt.eastus2-01.azurewebsites.net/Subjects/usuario/${docenteId}`, {
          method: 'GET',
          headers: getAuthHeaders()
        });
        if (res.ok) {
          const materias = await res.json();
          renderMaterias(materias);
        } else {
          throw new Error('No se pudieron cargar las materias.');
        }
      } catch (error) {
        console.error('Error al cargar materias:', error);
        mostrarAlerta('Error al cargar materias.', 'error');
      }
    }

    function renderMaterias(materias) {
      const materiasContainer = document.getElementById('materiasContainer');
      materiasContainer.innerHTML = '<option value="">Seleccione una materia</option>';
      materias.forEach(m => {
        const option = document.createElement('option');
        option.value = m._id;
        option.textContent = m.name;
        materiasContainer.appendChild(option);
      });
    }
    
    async function cargarTemas(materiaId) {
      try {
        const headers = getAuthHeaders();
        const res = await fetch(`${API_TOPICS}/materia/${materiaId}`, { headers });
        const listaTopics = await res.json();
        const topicSelect = document.getElementById('topicSelect');
        topicSelect.innerHTML = '<option value="">Seleccione un tema</option>';
        listaTopics.forEach(topic => {
          const option = document.createElement('option');
          option.value = topic._id;
          option.textContent = topic.name;
          option.dataset.subtopics = JSON.stringify(topic.subtopics);
          topicSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error cargando temas:', error);
      }
    }

    async function cargarAlumnos(materiaId, topicId) {
      try {
        const headers = getAuthHeaders();
        const resAlumnos = await fetch(`${API_ALUMNOS}/materia/${materiaId}`, { headers });
        const alumnos = await resAlumnos.json();
        const resTemas = await fetch(`${API_TOPICS}/materia/${materiaId}`, { headers });
        const temas = await resTemas.json();
        const resGradesGroupedBySubtopic = await fetch(`${API_GRADES}/topic/${topicId}`, { headers });
        const gradesGroupedBySubtopic = await resGradesGroupedBySubtopic.json();
        const temaSeleccionado = temas.find(tema => tema._id === topicId);
        const subtemas = temaSeleccionado ? temaSeleccionado.subtopics : [];
        tablaAlumnosBody.innerHTML = '';
        alumnos.forEach(alumno => {
          const row = document.createElement('tr');
          const subtemasHtml = subtemas.map(subtema => `<li>${subtema.name || 'Sin nombre'} </li>`).join('');
          const calificacionesMaxHtml = subtemas.map(subtema => `<li>${subtema.maxScore || 0}</li>`).join('');
          const calificacionesObHtml = subtemas.map(subtema => {
            const currentGrade = gradesGroupedBySubtopic.find(grade => grade.userId === alumno._id && grade.subtopicId === subtema._id);
            return `
              <div>
                <input type="number" 
                  min="0" 
                  max="${subtema.maxScore || 0}" 
                  class="calificacion-ob" 
                  data-subtopic-id="${subtema._id}" 
                  data-alumno-id="${alumno._id}"
                  data-max="${subtema.maxScore || 0}" 
                  value="${currentGrade ? currentGrade.grade : ''}"
                  placeholder="0"
                />
              </div>
            `;
          }).join('');
          row.innerHTML = `
            <td data-alumno-id="${alumno._id}">${alumno.name}</td>
            <td><ul style="list-style-type: none; padding-left: 0;">${subtemasHtml}</ul></td>
            <td><ul style="list-style-type: none; padding-left: 0;">${calificacionesMaxHtml}</ul></td>
            <td><ul style="list-style-type: none; padding-left: 0;">${calificacionesObHtml}</ul></td>
          `;
          tablaAlumnosBody.appendChild(row);
        });
        document.querySelectorAll('.calificacion-ob').forEach(input => {
          input.addEventListener('input', function () {
            const maxScore = parseFloat(this.getAttribute('data-max'));
            const value = parseFloat(this.value);
            if (value > maxScore) {
              mostrarAlerta(`La calificación no puede ser mayor que ${maxScore}`, 'error');
              this.value = maxScore;
            }
            if (value < 0) {
              mostrarAlerta(`La calificación no puede ser negativa`, 'error');
              this.value = 0;
            }
          });
        });
      } catch (error) {
        console.error('Error cargando alumnos o subtemas:', error);
      }
    }

    function mostrarAlerta(message, type = 'success') {
      const alertaContainer = document.getElementById('alertaContainer');
      const alertDiv = document.createElement('div');
      alertDiv.style.backgroundColor = type === 'error' ? '#f8d7da' : '#d4edda';
      alertDiv.style.color = type === 'error' ? '#721c24' : '#155724';
      alertDiv.style.padding = '12px';
      alertDiv.style.borderRadius = '5px';
      alertDiv.style.marginBottom = '10px';
      alertDiv.textContent = message;
      alertaContainer.appendChild(alertDiv);
      setTimeout(() => {
        alertDiv.remove();
      }, 4000);
    }

    document.getElementById('materiasContainer').addEventListener('change', (e) => {
      materiaId = e.target.value;
      document.getElementById('topicSelect').innerHTML = '<option value="">Seleccione un tema</option>';
      tablaAlumnosBody.innerHTML = '';
      if (materiaId) {
        cargarTemas(materiaId);
      }
    });

    document.getElementById('topicSelect').addEventListener('change', (e) => {
      const topicId = e.target.value;
      tablaAlumnosBody.innerHTML = '';
      if (materiaId && topicId) {
        cargarAlumnos(materiaId, topicId);
      }
    });
    
    // ===================================================================
    // FUNCIÓN sendGrades ACTUALIZADA Y CORREGIDA
    // ===================================================================
    async function sendGrades() {
      const subjectId = document.getElementById('materiasContainer').value;
      const topicId = document.getElementById('topicSelect').value;

      if (!subjectId || !topicId) {
        mostrarAlerta('Por favor, seleccione una materia y un tema.', 'error');
        return;
      }

      const studentRows = document.querySelectorAll('#tablaAlumnos tbody tr');
      let successCount = 0;
      let errorCount = 0;

      // Creamos un array de promesas para procesar a todos los alumnos
      const promises = Array.from(studentRows).map(async (row) => {
        const studentCell = row.querySelector('td[data-alumno-id]');
        if (!studentCell) return;

        const alumnoId = studentCell.dataset.alumnoId;
        const calificacionInputs = row.querySelectorAll('.calificacion-ob');
        const subTopicsForStudent = [];

        calificacionInputs.forEach(input => {
          const subTopicId = input.dataset.subtopicId;
          // Usamos valueAsNumber que devuelve NaN si está vacío o es inválido
          const grade = input.valueAsNumber;
          
          // Solo incluimos calificaciones que son números válidos (ignoramos las vacías)
          if (subTopicId && !isNaN(grade)) {
            subTopicsForStudent.push({ subTopicId, grade });
          }
        });

        // Si no hay calificaciones para este alumno, no hacemos nada
        if (subTopicsForStudent.length === 0) {
          return;
        }

        const data = {
          userId: alumnoId,
          subjectId,
          topicId,
          subTopics: subTopicsForStudent
        };

        try {
          // El front-end solo POSTEA. El back-end decide si crear o actualizar.
          const response = await fetch(API_GRADES, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify(data)
          });

          if (response.ok) {
            successCount++;
          } else {
            const errorData = await response.json();
            console.error(`Error con alumno ${alumnoId}:`, errorData.message || 'Error desconocido');
            errorCount++;
          }
        } catch (error) {
          console.error(`Error de red con alumno ${alumnoId}:`, error);
          errorCount++;
        }
      });

      // Esperamos a que todas las peticiones terminen
      await Promise.all(promises);

      if (errorCount > 0) {
        mostrarAlerta(`Se procesaron ${successCount} estudiantes correctamente. Fallaron ${errorCount}. Revise la consola para más detalles.`, 'error');
      } else {
        mostrarAlerta(`Calificaciones de ${successCount} estudiantes fueron procesadas exitosamente.`, 'success');
        // Opcional: Recargar las notas para ver los cambios reflejados desde el servidor
        cargarAlumnos(subjectId, topicId);
      }
    }

    async function sendRefuerzo() {
      const topicId = document.getElementById('topicSelect').value;
       if (!topicId) {
        mostrarAlerta('Por favor, seleccione un tema para generar el refuerzo.', 'error');
        return;
      }
      try {
        const response = await fetch(`https://mentoria-api-cyffg2cdemdyfdbt.eastus2-01.azurewebsites.net/academic-support/${topicId}/generate`, {
          method: 'GET',
          headers: getAuthHeaders(),
        });

        if (!response.ok) {
          throw new Error(`Error en la petición: ${response.status}`);
        }
        const data = await response.json();
        mostrarAlerta('Refuerzo académico generado correctamente.');
      } catch (error) {
        console.error('Error al generar refuerzo académico:', error);
        mostrarAlerta('Hubo un error al generar el refuerzo académico.', 'error');
      }
    }

    document.getElementById('enviarBtn').addEventListener('click', sendGrades);
    document.getElementById('refuerzoBtn').addEventListener('click', sendRefuerzo);
    
    window.onload = () => {
      cargarMaterias();
    };
  </script>
</body>

</html>